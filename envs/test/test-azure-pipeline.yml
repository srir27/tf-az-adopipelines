trigger:
  none

pool:
  name: 'self-hosted'

parameters:
  - name: environment
    type: string
    default: test
    displayName: 'Working Environment Name'
    values:
      - test
      - prod

stages:
  - stage: "testvalidation"
    jobs:
      - job: tfValidate
        steps:
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: '1.12.2'

          - script: |
              terraform init
              terraform validate
            workingDirectory: 'envs/${{ parameters.environment }}'
            env:
              ARM_SUBSCRIPTION_ID: $(TESTSUBSCRIPTIONID)
              
      - job: tfPlan
        steps:
          - script: |
              terraform init
              terraform plan -var-file="testvariables.tfvars" -out=tfplan
            workingDirectory: 'envs/${{ parameters.environment }}'
            env:
              ARM_SUBSCRIPTION_ID: $(TESTSUBSCRIPTIONID)
          - publish: 'envs/${{ parameters.environment }}'
            artifact: testplanfile
            
  - stage: "testdeployment"
    dependsOn: "testvalidation"
    condition: succeeded()
    jobs:
      - job: tfApply
        steps:
          - download: current
            artifact: testplanfile
          - script: |
              terraform init
              terraform apply "tfplan" -auto-approve
            workingDirectory: 'envs/${{ parameters.environment }}'
            env:
              ARM_SUBSCRIPTION_ID: $(TESTSUBSCRIPTIONID)


