trigger:
  none

pool:
  vmImage: 'self-hosted'

stages:
  - stage: "testvalidation"
    jobs:
      - job: tfValidate
        steps:
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: '1.12.2'
          - script: |
              terraform init
              terraform validate
            workingDirectory: 'envs/test'
      - job: tfPlan
        steps:
          - script: 
              terraform plan -var-file="testvariables.tfvars" -var="subscription_id=$(TEST_SUSBCRIPTION_ID)" -out=tfplan
            workingDirectory: 'envs/test'
          - publish: 'envs/test/tfplan'
            artifact: tfplanfile
            
  - stage: "testdeployment"
    dependsOn: "testvalidation"
    condition: succeeded()
    jobs:
      - job: tfApply
        steps:
          - download: current
            artifact: tfplanfile
          - script: |
              terraform apply "tfplan" -auto-approve


